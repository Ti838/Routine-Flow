<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Routine Architect - Routine Flow</title>
    <link rel="icon" type="image/png" href="../assets/img/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../assets/js/tailwind-config.js"></script>
    <link rel="stylesheet" href="../assets/css/zoom-fix.css">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <script>
        (function () {
            const saved = localStorage.getItem('theme');
            if (saved === 'dark' || saved === 'light') {
                if (saved === 'dark') document.documentElement.classList.add('dark');
            } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>
    <style>
        .studio-card {
            background: rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dark .studio-card {
            background: rgba(15, 23, 42, 0.4);
        }

        .studio-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border-color: rgba(99, 102, 241, 0.3);
        }

        @keyframes float {
            0% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }

            100% {
                transform: translateY(0px);
            }
        }

        .float-animation {
            animation: float 6s ease-in-out infinite;
        }
    </style>
</head>

<body class="bg-gray-50 dark:bg-[#0B1121] text-gray-900 dark:text-white antialiased transition-colors duration-300">

    <?php renderNavbar($role, $name); ?>

    <div class="max-w-[1600px] mx-auto flex">
        <?php renderSidebar($role, 'custom-routine.php'); ?>

        <main class="flex-1 p-6 lg:p-10 space-y-12">
            <header class="flex flex-col md:flex-row md:items-end justify-between gap-6">
                <div>
                    <div class="flex items-center gap-3 mb-2">
                        <span
                            class="px-3 py-1 bg-indigo-600/10 text-indigo-600 text-[10px] font-black uppercase tracking-[0.2em] rounded-full">Creative
                            Suite</span>
                    </div>
                    <h1 class="text-5xl font-black tracking-tighter">Routine Architect</h1>
                    <p class="text-gray-500 dark:text-gray-400 mt-2 font-bold uppercase tracking-widest text-[10px]">
                        Engineer your perfect academic presence</p>
                </div>

                <div
                    class="flex items-center gap-2 p-1.5 bg-white dark:bg-white/5 rounded-2xl border border-gray-100 dark:border-white/5">
                    <button id="tabBuilder" onclick="switchTab('builder')"
                        class="px-6 py-2.5 rounded-xl text-xs font-black uppercase tracking-widest transition-all">Manual
                        Builder</button>
                    <button id="tabVisual" onclick="switchTab('visual')"
                        class="px-6 py-2.5 rounded-xl text-xs font-black uppercase tracking-widest transition-all">Visual
                        Archive</button>
                    <button id="tabSync" onclick="switchTab('sync')"
                        class="px-6 py-2.5 rounded-xl text-xs font-black uppercase tracking-widest transition-all">Department
                        Sync</button>
                </div>
            </header>

            <?php if ($success_msg): ?>
            <div
                class="p-4 bg-emerald-500/10 border border-emerald-500/20 text-emerald-500 rounded-2xl font-black flex items-center gap-3 animate-in fade-in slide-in-from-top-2">
                <i class="ri-checkbox-circle-line text-xl"></i>
                <?php echo $success_msg; ?>
            </div>
            <?php endif; ?>

            <!-- MANNUAL BUILDER TAB -->
            <section id="builderTab" class="tab-content hidden space-y-10">
                <div class="grid grid-cols-1 xl:grid-cols-3 gap-10">
                    <div class="xl:col-span-1 space-y-8">
                        <div class="studio-card p-10 rounded-[40px] space-y-6">
                            <div
                                class="w-16 h-16 rounded-2xl bg-indigo-600 flex items-center justify-center text-white text-3xl shadow-xl shadow-indigo-600/30">
                                <i class="ri-quill-pen-line"></i>
                            </div>
                            <h3 class="text-2xl font-black">Objective Scaffolding</h3>
                            <p class="text-sm text-gray-500 leading-relaxed font-medium italic">"Precision in planning
                                leads to excellence in execution."</p>

                            <div class="pt-6 border-t border-gray-100 dark:border-white/5 space-y-4">
                                <div
                                    class="flex items-center justify-between text-[10px] font-black uppercase tracking-widest text-gray-400">
                                    <span>Total Drafts</span>
                                    <span id="manualDraftCount" class="text-indigo-600">0</span>
                                </div>
                                <button onclick="addRow()"
                                    class="w-full py-4 border-2 border-dashed border-gray-100 dark:border-white/10 rounded-3xl font-black text-xs uppercase tracking-widest hover:border-indigo-500 hover:text-indigo-500 transition-all">
                                    <i class="ri-add-line mr-2"></i> Append Objective
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="xl:col-span-2 space-y-8">
                        <div id="manualRows" class="space-y-4">
                            <!-- Rows injected here -->
                        </div>

                        <div class="pt-8 flex justify-end">
                            <button onclick="commitManualRoutine()" id="commitBtn"
                                class="px-10 py-5 bg-indigo-600 text-white rounded-[32px] font-black text-lg shadow-2xl shadow-indigo-600/40 hover:scale-105 active:scale-95 transition-all flex items-center gap-3">
                                <i class="ri-rocket-2-fill"></i> Launch Routine
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- VISUAL ARCHIVE TAB -->
            <section id="visualTab" class="tab-content hidden space-y-10">
                <div class="grid grid-cols-1 xl:grid-cols-4 gap-10">
                    <section class="xl:col-span-1 space-y-8">
                        <div class="studio-card p-10 rounded-[40px] space-y-8">
                            <h3 class="text-2xl font-black">Image Engine</h3>
                            <p class="text-xs font-bold text-gray-400 uppercase tracking-widest leading-loose">Upload
                                your physical routine or documents for instant digital access.</p>

                            <form action="custom-routine.php" method="POST" enctype="multipart/form-data"
                                class="space-y-6">
                                <input type="hidden" name="upload_image" value="1">
                                <div class="relative group">
                                    <input type="file" name="routine_image" required accept="image/*,.pdf"
                                        class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
                                        onchange="previewUpload(this)">
                                    <div
                                        class="w-full h-40 border-2 border-dashed border-gray-200 dark:border-white/10 rounded-[32px] flex flex-col items-center justify-center group-hover:border-indigo-500 transition-all overflow-hidden bg-gray-50/50 dark:bg-black/20">
                                        <div id="uploadPreview" class="text-center px-4">
                                            <i
                                                class="ri-upload-cloud-2-line text-4xl text-gray-300 group-hover:text-indigo-500 mb-2"></i>
                                            <span
                                                class="text-[10px] font-black uppercase tracking-widest text-gray-400 block">Deploy
                                                Image or PDF</span>
                                        </div>
                                    </div>
                                </div>
                                <input type="text" name="description" placeholder="Label (e.g. Club Schedule)"
                                    class="w-full px-6 py-3 bg-gray-50 dark:bg-white/5 border border-transparent focus:border-indigo-600 rounded-2xl text-[10px] font-black uppercase tracking-widest outline-none">
                                <button type="submit"
                                    class="w-full py-4 bg-indigo-600 text-white rounded-2xl font-black text-xs uppercase tracking-widest hover:scale-105 transition-all shadow-lg shadow-indigo-500/20">Sync
                                    to Archive</button>
                            </form>
                        </div>
                    </section>

                    <section class="xl:col-span-3 grid grid-cols-1 md:grid-cols-2 gap-8">
                        <?php foreach ($personal_files as $file): ?>
                        <div class="studio-card p-4 rounded-[40px] group overflow-hidden relative">
                            <div class="relative rounded-[32px] overflow-hidden bg-black aspect-video mb-6">
                                <?php if($file['file_type'] === 'pdf'): ?>
                                <div class="w-full h-full flex items-center justify-center bg-red-500/10 text-red-500">
                                    <i class="ri-file-pdf-fill text-6xl"></i>
                                </div>
                                <?php else: ?>
                                <img src="../<?php echo $file['file_path']; ?>"
                                    class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity">
                                <?php endif; ?>
                                <div
                                    class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent flex items-end p-8">
                                    <div>
                                        <h4 class="text-xl font-black text-white">
                                            <?php echo htmlspecialchars($file['description']); ?>
                                        </h4>
                                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mt-1">
                                            <?php echo date('F j, Y', strtotime($file['created_at'])); ?>
                                        </p>
                                    </div>
                                </div>
                                <div class="absolute top-4 right-4 flex gap-2">
                                    <button onclick="openAdvisor(this)" data-path="../<?php echo $file['file_path']; ?>"
                                        data-type="<?php echo $file['file_type']; ?>"
                                        class="w-10 h-10 rounded-xl bg-indigo-600 text-white flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all hover:scale-110 shadow-lg">
                                        <i class="ri-magic-line"></i>
                                    </button>
                                    <a href="../api/download_routine.php?id=<?php echo $file['id']; ?>&type=file"
                                        class="w-10 h-10 rounded-xl bg-white/10 backdrop-blur-md text-white flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all hover:bg-white/20">
                                        <i class="ri-download-2-line"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                        <?php endforeach; ?>
                        <?php if (empty($personal_files)): ?>
                        <div
                            class="md:col-span-2 p-20 text-center border-2 border-dashed border-gray-100 dark:border-white/5 rounded-[40px] opacity-30">
                            <i class="ri-archive-line text-6xl block mb-4"></i>
                            <h4 class="text-xl font-black uppercase tracking-widest">Archive Empty</h4>
                        </div>
                        <?php endif; ?>
                    </section>
                </div>
            </section>

            <!-- SYNC TAB -->
            <section id="syncTab" class="tab-content hidden space-y-10 animate-in fade-in duration-500">
                <div class="flex items-center justify-between mb-8">
                    <h3 class="text-3xl font-black">Official Schedule Synchronization</h3>
                    <div class="flex items-center gap-2">
                        <span
                            class="px-3 py-1 bg-yellow-400/10 text-yellow-500 text-[10px] font-black uppercase tracking-widest rounded-lg">Level:
                            Core Routine</span>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 2xl:grid-cols-3 gap-8">
                    <?php foreach ($routines as $row): 
                        $color = !empty($row['color_code']) ? $row['color_code'] : 'indigo'; 
                    ?>
                    <div
                        class="studio-card p-10 rounded-[48px] relative border-l-8 border-l-<?php echo $color; ?>-500 group">
                        <div class="flex justify-between items-start mb-8">
                            <div
                                class="w-16 h-16 rounded-[24px] bg-<?php echo $color; ?>-500/10 text-<?php echo $color; ?>-500 flex items-center justify-center text-3xl font-black">
                                <?php echo substr($row['subject_name'], 0, 1); ?>
                            </div>
                            <button onclick="toggleStar(this)" data-id="<?php echo $row['id']; ?>"
                                class="text-3xl transition-all <?php echo $row['is_starred'] ? 'text-yellow-400 ri-star-fill' : 'text-gray-200 ri-star-line'; ?> hover:scale-125">
                            </button>
                        </div>

                        <div class="space-y-4">
                            <h4 class="text-2xl font-black leading-tight">
                                <?php echo htmlspecialchars($row['subject_name']); ?>
                            </h4>
                            <div class="flex flex-wrap gap-2 pt-2">
                                <span
                                    class="px-4 py-1.5 bg-gray-50 dark:bg-white/5 rounded-xl text-[10px] font-black uppercase tracking-widest">
                                    <?php echo $row['day_of_week']; ?>
                                </span>
                                <span
                                    class="px-4 py-1.5 bg-gray-50 dark:bg-white/5 rounded-xl text-[10px] font-black uppercase tracking-widest">
                                    <?php echo date('H:i', strtotime($row['start_time'])); ?> -
                                    <?php echo date('H:i', strtotime($row['end_time'])); ?>
                                </span>
                            </div>
                        </div>

                        <div
                            class="mt-10 pt-8 border-t border-gray-100 dark:border-white/5 flex items-center justify-between">
                            <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Faculty: <span
                                    class="text-gray-900 dark:text-white">
                                    <?php echo $row['teacher_name']; ?>
                                </span></p>

                            <div class="flex gap-2">
                                <?php foreach(['indigo', 'emerald', 'pink', 'orange', 'purple'] as $c): ?>
                                <button onclick="updateColor(this, '<?php echo $c; ?>')"
                                    data-id="<?php echo $row['id']; ?>"
                                    class="w-4 h-4 rounded-full bg-<?php echo $c; ?>-500 hover:scale-150 transition-all"></button>
                                <?php endforeach; ?>
                            </div>
                        </div>
                    </div>
                    <?php endforeach; ?>
                </div>
            </section>
        </main>
    </div>

    <!-- Routine Advisor Side-Panel -->
    <div id="advisorPanel"
        class="fixed inset-y-0 right-0 w-[500px] bg-white dark:bg-[#0F172A] shadow-2xl z-[100] translate-x-full transition-transform duration-500 border-l border-gray-100 dark:border-white/5 flex flex-col">
        <div class="p-8 border-b border-gray-100 dark:border-white/5 flex items-center justify-between">
            <div>
                <h3 class="text-xl font-black">Routine Advisor</h3>
                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Resource Analysis Mode</p>
            </div>
            <button onclick="closeAdvisor()"
                class="w-10 h-10 rounded-xl hover:bg-gray-100 dark:hover:bg-white/5 transition-all">
                <i class="ri-close-line text-2xl"></i>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto p-8 space-y-8">
            <div id="advisorPreview"
                class="rounded-3xl overflow-hidden bg-gray-50 dark:bg-black/40 aspect-[3/4] border border-gray-100 dark:border-white/5">
                <!-- Content Injected -->
            </div>

            <div class="space-y-6">
                <div class="p-6 bg-indigo-600/5 rounded-3xl border border-indigo-600/10">
                    <h4 class="text-sm font-black text-indigo-600 mb-2 flex items-center gap-2">
                        <i class="ri-lightbulb-line"></i> Advisor Tip
                    </h4>
                    <p class="text-[11px] font-medium text-gray-500 leading-relaxed italic">
                        "Observe the sessions in your resource and quickly map them to your digital timeline using the
                        Builder tab."
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script src="../assets/js/theme.js"></script>
    <script>
        // Tab Management
        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById(tab + 'Tab').classList.remove('hidden');

            ['Builder', 'Visual', 'Sync'].forEach(t => {
                const btn = document.getElementById('tab' + t);
                btn.className = tab.toLowerCase() === t.toLowerCase()
                    ? 'px-6 py-2.5 rounded-xl bg-gray-900 dark:bg-white text-white dark:text-black text-xs font-black uppercase tracking-widest shadow-xl transition-all'
                    : 'px-6 py-2.5 rounded-xl text-gray-500 hover:text-indigo-600 dark:hover:text-indigo-400 text-xs font-black uppercase tracking-widest transition-all';
            });

            localStorage.setItem('activeArchitectTab', tab);
        }

        // Initialize with default tab
        switchTab(localStorage.getItem('activeArchitectTab') || 'builder');

        // Advisor Logic
        function openAdvisor(btn) {
            const path = btn.dataset.path;
            const type = btn.dataset.type;
            const panel = document.getElementById('advisorPanel');
            const preview = document.getElementById('advisorPreview');

            if (type === 'pdf') {
                preview.innerHTML = `<iframe src="${path}" class="w-full h-full border-none"></iframe>`;
            } else {
                preview.innerHTML = `<img src="${path}" class="w-full h-full object-contain">`;
            }

            panel.classList.remove('translate-x-full');
            switchTab('builder'); // Auto switch to builder to help summarize
        }

        function closeAdvisor() {
            document.getElementById('advisorPanel').classList.add('translate-x-full');
        }

        // Manual Builder Logic
        function addRow() {
            const container = document.getElementById('manualRows');
            const rowId = Date.now();
            const html = `
                <div class="studio-card p-8 rounded-[40px] relative animate-in slide-in-from-right-10 duration-500" id="row_${rowId}">
                    <button onclick="removeRow(${rowId})" class="absolute top-6 right-6 text-gray-300 hover:text-red-500 text-xl"><i class="ri-delete-bin-7-line"></i></button>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-1">
                            <label class="text-[9px] font-black text-gray-400 uppercase tracking-[0.2em] ml-4">Subject/Title</label>
                            <input type="text" class="subject w-full px-8 py-4 bg-gray-50 dark:bg-black/20 border-transparent focus:border-indigo-500 rounded-3xl outline-none font-black text-sm" placeholder="e.g. Self Study: AI Ethics">
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:col-span-1">
                             <div class="space-y-1">
                                <label class="text-[9px] font-black text-gray-400 uppercase tracking-[0.2em] ml-2">Day</label>
                                <select class="day w-full px-4 py-4 bg-gray-50 dark:bg-black/20 border-transparent focus:border-indigo-500 rounded-2xl outline-none font-bold text-xs">
                                    <option>Monday</option><option>Tuesday</option><option>Wednesday</option>
                                    <option>Thursday</option><option>Friday</option><option>Saturday</option><option>Sunday</option>
                                </select>
                            </div>
                            <div class="space-y-1">
                                <label class="text-[9px] font-black text-gray-400 uppercase tracking-[0.2em] ml-2">From</label>
                                <input type="time" class="start w-full px-4 py-4 bg-gray-50 dark:bg-black/20 border-transparent focus:border-indigo-500 rounded-2xl outline-none font-bold text-xs" value="08:00">
                            </div>
                            <div class="space-y-1">
                                <label class="text-[9px] font-black text-gray-400 uppercase tracking-[0.2em] ml-2">To</label>
                                <input type="time" class="end w-full px-4 py-4 bg-gray-50 dark:bg-black/20 border-transparent focus:border-indigo-500 rounded-2xl outline-none font-bold text-xs" value="09:30">
                            </div>
                            <div class="space-y-1">
                                <label class="text-[9px] font-black text-gray-400 uppercase tracking-[0.2em] ml-2">Flavor</label>
                                <select class="color w-full px-4 py-4 bg-gray-50 dark:bg-black/20 border-transparent focus:border-indigo-500 rounded-2xl outline-none font-bold text-xs">
                                    <option value="indigo">Indigo</option>
                                    <option value="emerald">Emerald</option>
                                    <option value="pink">Pink</option>
                                    <option value="orange">Orange</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
            updateDraftCount();
        }

        function removeRow(id) {
            document.getElementById('row_' + id).remove();
            updateDraftCount();
        }

        function updateDraftCount() {
            document.getElementById('manualDraftCount').textContent = document.querySelectorAll('#manualRows > div').length;
        }

        async function commitManualRoutine() {
            const rows = document.querySelectorAll('#manualRows > div');
            if (rows.length === 0) return alert('Draft at least one objective');

            const items = Array.from(rows).map(row => ({
                title: row.querySelector('.subject').value,
                day: row.querySelector('.day').value,
                start: row.querySelector('.start').value,
                end: row.querySelector('.end').value,
                color: row.querySelector('.color').value,
                action: 'add'
            }));

            if (items.some(i => !i.title)) return alert('Enter title for all objectives');

            const btn = document.getElementById('commitBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="ri-loader-4-line animate-spin"></i> Processing...';

            try {
                for (const item of items) {
                    await fetch('../api/student_scheduler.php', {
                        method: 'POST',
                        body: JSON.stringify(item)
                    });
                }
                alert('All objectives launched to your horizon!');
                location.reload();
            } catch (e) { alert('Network failure'); }

            btn.disabled = false;
        }

        // Image Preview
        function previewUpload(input) {
            const preview = document.getElementById('uploadPreview');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => {
                    const isPdf = input.files[0].type === 'application/pdf';
                    preview.innerHTML = isPdf
                        ? `<i class="ri-file-pdf-fill text-6xl text-red-500"></i><p class="text-[10px] font-black uppercase mt-2">${input.files[0].name}</p>`
                        : `<img src="${e.target.result}" class="w-full h-full object-cover">`;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Customization Logic (Stars & Colors)
        async function toggleStar(btn) {
            const routineId = btn.dataset.id;
            const isStarred = btn.classList.contains('ri-star-fill');
            const newState = !isStarred;

            btn.className = newState ? 'text-yellow-400 ri-star-fill text-3xl transition-all' : 'text-gray-200 ri-star-line text-3xl transition-all';

            try {
                await fetch('../api/customize_routine.php', {
                    method: 'POST',
                    body: JSON.stringify({ routine_id: routineId, is_starred: newState })
                });
            } catch (e) { }
        }

        async function updateColor(btn, color) {
            const routineId = btn.dataset.id;
            const card = btn.closest('.studio-card');
            card.className = card.className.replace(/border-l-\w+-500/, `border-l-${color}-500`);
            const icon = card.querySelector('.w-16');
            icon.className = icon.className.replace(/bg-\w+-500/, `bg-${color}-500`).replace(/text-\w+-500/, `text-${color}-500`);

            try {
                await fetch('../api/customize_routine.php', {
                    method: 'POST',
                    body: JSON.stringify({ routine_id: routineId, color_code: color })
                });
            } catch (e) { }
        }

        // Start with one row
        if (document.querySelectorAll('#manualRows > div').length === 0) addRow();
    </script>
</body>

</html>
```